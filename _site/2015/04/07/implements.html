<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="keywords" content="opensource, junit3, java"/>
        <meta name="author" content="ivanpig.github.io"> 
        <link rel="canonical" href="http://ivanpig.github.io/2015/04/07/implements.html">
        <link href="http://ivanpig.github.io/rss.xml" title="RSS 2.0" type="application/rss+xml" rel="alternate"/>
        <link href="/img/favicon.ico" rel="icon" type="image/x-icon">
        <title>读源码-JUnit3实现 - 不懂管理的开发不是好架构</title>
        <link rel="stylesheet" href="/css/min/pure-min.css">
        <!--[if lte IE 8]>
<link rel="stylesheet" href="/css/min/grids-responsive-old-ie-min.css">
<![endif]-->
        <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="/css/min/grids-responsive-min.css">
        <!--<![endif]-->

        <!--[if lte IE 8]>
<link rel="stylesheet" href="/css/JekyllPure-old-ie.css">
<![endif]-->
        <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="/css/JekyllPure.css">
        <!--<![endif]-->

        <link href="/css/min/font-awesome.min.css" rel="stylesheet">
        <!--[if lte IE 8]>
<link rel="stylesheet" href="/css/min/font-awesome-ie7.min.css">
<![endif]-->
        <script src="/js/min/jquery-1.7.2.min.js"></script>
        <link rel="stylesheet" href="/css/themes/my.css"/>
        <script src="/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </head>

    <body>

        <div id="layout" class="pure-g">
            <div class="sidebar pure-u-1 pure-u-md-1-4">
                <div class="header">
                    <div class="headerpic">
                        <a href="/">
                            <img src="/img/head.jpg" alt="Profile Picture" style="width: 140px;" title="返回首页">
                        </a>
                    </div>
                    <!-- <h1 class="brand-title">IvanPig's Blog</h1>-->
                    <h2 id="_tagline" class="brand-tagline">Just Perfect</h2>
<!--                     <br class="newline"/><br class="newline"/> -->

                    <nav class="nav">
                        <ul class="nav-list">
                            <li class="nav-item">
                                <a class="pure-button" href="/Timing">时间轴</a>
                            </li>
                            <li class="nav-item">
                                <a class="pure-button" href="/tag">标签库</a>
                            </li>
                            <li class="nav-item">
                                <a class="pure-button" href="/type">分类库</a>
                            </li>
                        </ul>
                    </nav>
                    <div class="search">
                        <form action="/search">
                            <input type="text" class="search-query" placeholder="Search Blog" name="query" title="全站搜索-只支持英文">
                        </form>
                    </div>

                    <div id="toc"></div>
                    <div id="toc1"></div>
                    <nav id="nav">
                        <ul class="nav-list">
                            <li class="nav-link">
                                <a class="weibo "  href="http://weibo.com/1686537657/profile?topnav=1&wvr=6" ><i class="fa fa-weibo fa-2x"></i></a>
                            </li>
                            <li class="nav-link">
                                <a class="github" href="https://github.com/ivanpig"><i class="fa fa-github fa-2x"></i></a>
                            </li>
                            <li class="nav-link">
                                <a class="rss" href="/rss.xml" ><i class="fa fa-rss fa-2x"></i></a>
                            </li>
                        </ul>
                    </nav>
							<div id="qrcode">
							<img src="/img/qrcode.jpg" width="170"/>
							</div>
                </div>
            </div>

            <div class="content pure-u-1 pure-u-md-3-4">
                <!--[if lt IE 8]>
<i class="label label-danger">亲爱的用户，您的浏览器版本过低，建议您升级浏览器获得更好的用户体验</i>
<![endif]-->
                <div>
                    <div class="posts">

                        <div class="qrcodeTable"></div>
<header class="post-header">
    
    <img class="post-avatar" height="48" width="48"
         src="/img/head.jpg">
    

    <h2 class="post-title">读源码-JUnit3实现</h2>

    <p class="post-meta">By 04月07日  2015
        
        
        
        
        <a class="post-categorybut " href="/type/#"><i class="fa fa-folder-open">junit3 (3)</i></a>
        
        
        

        
        
        
        
        <a class="post-category " href="/tag/#opensource"><i class="fa fa-tags">opensource (4)</i></a>
        
        <a class="post-category " href="/tag/#opensource"><i class="fa fa-tags">junit3 (3)</i></a>
        
        <a class="post-category " href="/tag/#opensource"><i class="fa fa-tags">java (48)</i></a>
        
        
    
    
</header>
<div class="article pure-u-22-24">
    <p><em>Level :</em> &hearts;&hearts;</p>

<h1>内容回顾</h1>

<ul>
<li>上篇内容主要介绍了JUnit3的使用</li>
<li>如何编写测试类</li>
<li>如何运行单个测试类</li>
<li>如何运行多个测试类</li>
<li>如何设置Class级别的setUp()和tearDown()方法</li>
<li>如何多次运行测试</li>
</ul>


<p>本篇文章将梳理JUnit3源码</p>

<h1>代码结构</h1>

<p>上篇最后给出了测试UML图</p>

<p><img src="/assets/opensource/junit3/diagram2.png" alt="" /></p>

<p>我们可以看出</p>

<ul>
<li>所有的测试类都继承了TestCase这个类</li>
<li>TestCase这个类继承了Assert类，实现了Test接口</li>
</ul>


<h1>Assert类</h1>

<p>我们先看Assert这个类，你会发现这个类很简单，提供了各种静态的assert*()方法来进行比较。</p>

<h1>Test接口</h1>

<pre><code class="java">package junit.framework;

public interface Test {
    public abstract int countTestCases();
    public abstract void run(TestResult result);
}
</code></pre>

<!-- more -->


<p>Test接口有两个方法</p>

<ul>
<li>countTestCases()方法:统计需要运行的测试的数量</li>
<li>run(result)方法:顾名思义就是用来跑测试的</li>
</ul>


<h1>TeseCase类</h1>

<p>TestCase实现了Test接口，那么肯定需要实现如上两个方法</p>

<pre><code class="java">public abstract class TestCase extends Assert implements Test {

  ...

  public int countTestCases() {
        return 1;
    }

  public void run(TestResult result) {
        result.run(this);
    }

  ...

}
</code></pre>

<ul>
<li>countTestCases()方法返回1</li>
<li>run(result)方法中，是调用TestResult()中的run(Test)方法</li>
</ul>


<p>那么问题来了？为什么要传入一个TestResult，然后再将自身传递给TestResult去执行呢？下篇分析！</p>

<h1>TestResult类</h1>

<p>TestResult类看名字也能才出来，是用来收集测试结果的类.</p>

<pre><code class="java">protected void run(final TestCase test) {
  startTest(test);
  Protectable p= new Protectable() {
    public void protect() throws Throwable {
      test.runBare();
    }
  };
  runProtected(test, p);

  endTest(test);
}

public void runProtected(final Test test, Protectable p) {
  try {
    p.protect();
  }catch (AssertionFailedError e) {
    addFailure(test, e);
  }catch (ThreadDeath e) { // don't catch ThreadDeath by accident
    throw e;
  }catch (Throwable e) {
    addError(test, e);
  }
}
</code></pre>

<ul>
<li>startTest(test)方法是触发添加的Listener的</li>
<li>后面构建了一个Protectable对象，里面运行test.runBare()</li>
<li>调用runProtected方法，你会发现runProtected方法就是调用Protectable的protect方法。是不是有点多此一举？继续留悬念，后面解释!</li>
<li>endTest(test)方法也是触发添加的Listener的</li>
</ul>


<h1>TestCase.runBare()</h1>

<p>我们再次回到了TestCase方法，看看runBare()方法</p>

<pre><code class="java">public void runBare() throws Throwable {
  Throwable exception= null;
  setUp();
  try {
    runTest();
  } catch (Throwable running) {
    exception= running;
  } finally {
    try {
      tearDown();
    } catch (Throwable tearingDown) {
      if (exception == null) exception= tearingDown;
    }
  }
  if (exception != null) throw exception;
}
</code></pre>

<ul>
<li>从这里的代码，我们终于看到了测试执行的一个大致流程</li>
<li>先执行setUp()方法，接着runTest()，最后tearDown()。是不是就是我们的测试执行流程呢？</li>
</ul>


<p>我们分别来看看这三个方法在TestCase中的实现:</p>

<ul>
<li>setUp()</li>
</ul>


<pre><code class="java">protected void setUp() throws Exception {
}
</code></pre>

<ul>
<li>tearDown()</li>
</ul>


<pre><code class="java">protected void tearDown() throws Exception {
}
</code></pre>

<p>上面两个方法主要就是给子类覆盖的！</p>

<ul>
<li>runTest()</li>
</ul>


<pre><code class="java">protected void runTest() throws Throwable {
  assertNotNull(fName); // Some VMs crash when calling  getMethod(null,null);
  Method runMethod= null;
  try {
    // use getMethod to get all public inherited
    // methods. getDeclaredMethods returns all
    // methods of this class but excludes the
    // inherited ones.
    runMethod= getClass().getMethod(fName, (Class[])null);
  } catch (NoSuchMethodException e) {
    fail("Method \""+fName+"\" not found");
  }
  if (!Modifier.isPublic(runMethod.getModifiers())) {
    fail("Method \""+fName+"\" should be public");
  }

  try {
    runMethod.invoke(this, (Object[])new Class[0]);
  } catch (InvocationTargetException e) {
    e.fillInStackTrace();
    throw e.getTargetException();
  } catch (IllegalAccessException e) {
    e.fillInStackTrace();
    throw e;
  }
}
</code></pre>

<p>这里就是通过反射来获取方法进而执行！</p>

<h1>入口</h1>

<p>如上的代码，只是测试结构代码。如何执行上面的测试代码呢？必然有个main方法啊！</p>

<p>在上篇中通过命令行执行</p>

<pre><code>java junit.textui.TestRunner org.ivan.TestAll
</code></pre>

<p>可以看到，入口类为TestRunner</p>

<h1>TestRunner类</h1>

<pre><code class="java">public static void main(String args[]) {
  TestRunner aTestRunner= new TestRunner();
  try {
    TestResult r= aTestRunner.start(args);
    if (!r.wasSuccessful())
    System.exit(FAILURE_EXIT);
    System.exit(SUCCESS_EXIT);
  } catch(Exception e) {
    System.err.println(e.getMessage());
    System.exit(EXCEPTION_EXIT);
  }
}

public TestResult start(String args[]) throws Exception {
  String testCase= "";
  String method= "";
  boolean wait= false;

  for (int i= 0; i &lt; args.length; i++) {
    if (args[i].equals("-wait"))
    wait= true;
    else if (args[i].equals("-c"))
    testCase= extractClassName(args[++i]);
    else if (args[i].equals("-m")) {
    String arg= args[++i];
    int lastIndex= arg.lastIndexOf('.');
    testCase= arg.substring(0, lastIndex);
    method= arg.substring(lastIndex + 1);
  } else if (args[i].equals("-v"))
    System.err.println("JUnit " + Version.id() + " by Kent Beck and Erich Gamma");
    else
    testCase= args[i];
  }

  if (testCase.equals(""))
    throw new Exception("Usage: TestRunner [-wait] testCaseName, where name is the name of the TestCase class");

  try {
    if (!method.equals(""))
    return runSingleMethod(testCase, method, wait);
    Test suite= getTest(testCase);
    return doRun(suite, wait);
  } catch (Exception e) {
    throw new Exception("Could not create and run test suite: " + e);
  }
}
</code></pre>

<ul>
<li>TestRunner中的核心方法为start方法，主要解析传递的参数，并执行相应的测试</li>
<li>其中Test suite= getTest(testCase);返回的实际上是TestSuite。也就是说，即使你不将TestCase添加到TestSuite中，JUnit也会自动帮你进行封装</li>
<li>doRun就是实际的运行测试的方法了</li>
</ul>


<pre><code class="java">public TestResult doRun(Test suite, boolean wait) {
  TestResult result= createTestResult();
  result.addListener(fPrinter);
  long startTime= System.currentTimeMillis();
  suite.run(result);
  long endTime= System.currentTimeMillis();
  long runTime= endTime-startTime;
  fPrinter.print(result, runTime);

  pause(wait);
  return result;
}
</code></pre>

<ul>
<li>首先实例化一个TestResult，然后添加Listener</li>
<li>执行TestSuite的run方法</li>
<li>输出</li>
</ul>


<h1>TestSuite</h1>

<pre><code class="java">public void run(TestResult result) {
for (Enumeration e= tests(); e.hasMoreElements(); ) {
  if (result.shouldStop() )
    break;
    Test test= (Test)e.nextElement();
    runTest(test, result);
  }
}

public void runTest(Test test, TestResult result) {
  test.run(result);
}
</code></pre>

<ul>
<li>我们知道TestSuite中是Test的集合，这里run方法，就是遍历TestSuite中的Test并调用runTest方法</li>
<li>而runTest方法实际上就是调用test的run方法</li>
</ul>


<p>那Test是如何添加到TestSuite中的呢？这个动作是在实例化TestSuite时进行的!</p>

<pre><code class="java">public TestSuite(final Class theClass) {
  fName= theClass.getName();
  try {
    getTestConstructor(theClass); // Avoid generating multiple error messages
  } catch (NoSuchMethodException e) {
    addTest(warning("Class "+theClass.getName()+" has no public constructor TestCase(String name) or TestCase()"));
    return;
  }

  if (!Modifier.isPublic(theClass.getModifiers())) {
    addTest(warning("Class "+theClass.getName()+" is not public"));
    return;
  }

  Class superClass= theClass;
  Vector names= new Vector();
  while (Test.class.isAssignableFrom(superClass)) {
    Method[] methods= superClass.getDeclaredMethods();
    for (int i= 0; i &lt; methods.length; i++) {
      addTestMethod(methods[i], names, theClass);
    }
    superClass= superClass.getSuperclass();
  }
  if (fTests.size() == 0)
  addTest(warning("No tests found in "+theClass.getName()));
}
</code></pre>

<ul>
<li>核心功能就是addTestMethod方法</li>
</ul>


<pre><code class="java">private void addTestMethod(Method m, Vector names, Class theClass) {
  String name= m.getName();
  if (names.contains(name))
    return;
  if (!isPublicTestMethod(m)) {
    if (isTestMethod(m))
      addTest(warning("Test method isn't public: "+m.getName()));
    return;
  }
  names.addElement(name);
  addTest(createTest(theClass, name));
}

private boolean isTestMethod(Method m) {
    String name= m.getName();
    Class[] parameters= m.getParameterTypes();
    Class returnType= m.getReturnType();
    return parameters.length == 0 &amp;&amp; name.startsWith("test") &amp;&amp; returnType.equals(Void.TYPE);
}
</code></pre>

<ul>
<li>isTestMethod方法用来判断是否为测试方法</li>
<li>是测试方法的条件是:方法没有参数，方法名以test开头，且没有返回值</li>
<li>如果是测试方法，则添加到Test集合里</li>
</ul>


<p>这就是整个JUnit的执行流程！</p>

<h1>时序图</h1>

<p><img src="/assets/opensource/junit3/junit_seq.png" alt="" /></p>

<h1>UML</h1>

<p><img src="/assets/opensource/junit3/diagram.png" alt="" /></p>

</div>

<div class="pure-g pagination">
    
        
        
        
        <a class="pure-u-1-2 pagination-item " href="/2015/04/06/use.html" title="读源码-JUnit3使用 "><p> <i class="fa fa-mail-reply"></i>&nbsp;读源码-JUnit3使用</p></a>
        
        
        
        
        <a class="pure-u-1-2 pagination-item " href="/2015/04/08/why.html" title="读源码-JUnit3设计"><p>读源码-JUnit3设计&nbsp;<i class="fa fa-mail-forward"></i></p></a>
        
    
</div>
<link href="/css/code.css" rel="stylesheet">
<link href="/css/min/fancybox.css" rel="stylesheet">
<script src="/js/min/jquery.toc.min.js" ></script>
<script src="/js/min/jquery.qrcode.min.js" ></script>
<script src="/js/min/jquery.fancybox.pack.js" ></script>
<script src="/js/page.js" ></script>


<!--多说分享-->
<div class="ds-share" data-thread-key="/2015/04/07/implements" data-title="读源码-JUnit3实现" data-images="/img/head.jpg" data-url="http://ivanpig.github.io/2015/04/07/implements.html">
    <div class="ds-share-aside-right">
      <div class="ds-share-aside-inner">
      </div>
      <div class="ds-share-aside-toggle">分享到</div>
    </div>
</div>



<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="/2015/04/07/implements" data-title="读源码-JUnit3实现" data-url="/2015/04/07/implements.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"ivanpig"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->








                    </div>
                </div>
                <div class="footer">
                    <a href="/about.html">About</a>
                    <a href="tencent://message/?uin=561802774">QQ</a>
                    <a href="https://github.com/ivanpig">GitHub</a>
                    <script src="/js/min/nprogress.min.js"></script>
                    <script src="/js/index.js"></script>
                </div>
                <div class="topfade"><a href="javascript:;" title="返回顶部"></a></div>

            </div>

        </div>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F2278992c92bf7ea162797e107e900616' type='text/javascript'%3E%3C/script%3E"));
</script>

    </body>

</html>
