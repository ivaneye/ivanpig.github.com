<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="keywords" content=""/>
    <meta name="author" content="liyouhai.com"> 
    <link rel="canonical" href="http://liyouhai.com/clojure/clojure%25e6%2595%2599%25e7%25a8%258brecord%25e5%2592%258cprotocol.html">
    <link href="http://liyouhai.com/rss.xml" title="RSS 2.0" type="application/rss+xml" rel="alternate"/>
    <link href="/img/favicon.ico" rel="icon" type="image/x-icon">
    <title>Clojure教程:Record和Protocol - IvanPig's Blog</title>
    <link rel="stylesheet" href="/css/min/pure-min.css">
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/min/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="/css/min/grids-responsive-min.css">
    <!--<![endif]-->

    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/JekyllPure-old-ie.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="/css/JekyllPure.css">
    <!--<![endif]-->

    <link href="/css/min/font-awesome.min.css" rel="stylesheet">
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/css/min/font-awesome-ie7.min.css">
    <![endif]-->
    <script src="/js/min/jquery-1.7.2.min.js"></script>
    <!--
     /\_ \    __                         /\ \                __
     \//\ \  /\_\  __  __    ___   __  __\ \ \___      __   /\_\
       \ \ \ \/\ \/\ \/\ \  / __`\/\ \/\ \\ \  _ `\  /'__`\ \/\ \
        \_\ \_\ \ \ \ \_\ \/\ \L\ \ \ \_\ \\ \ \ \ \/\ \L\.\_\ \ \
        /\____\\ \_\/`____ \ \____/\ \____/ \ \_\ \_\ \__/.\_\\ \_\
        \/____/ \/_/`/___/> \/___/  \/___/   \/_/\/_/\/__/\/_/ \/_/
                       /\___/
                       \/__/
     图像可以到http://asciigen.com/  生成..记得翻墙才能正常生成.如不方便可以博客留言我帮你生成
     -->
</head>

<body>







<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
        <div class="header">
            <div class="headerpic">
                <a href="/">
                    <img src="/img/op.jpg" alt="Profile Picture" style="width: 140px;" title="返回首页">
                </a>
            </div>
            <!-- <h1 class="brand-title">IvanPig's Blog</h1>-->
            <h2 class="brand-tagline">IvanPig's Blog</h2>

            <nav class="nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a class="pure-button" href="/Timing">时间轴</a>
                    </li>
                    <li class="nav-item">
                        <a class="pure-button" href="/tag">标签库</a>
                    </li>
                    <!--<li class="nav-item">
                        <a class="pure-button" href="/1">收藏站</a>
                    </li>
                    <li class="nav-item">
                        <a class="pure-button" href="/1">音乐屋</a>-->

                </ul>
            </nav>
            <div class="search">
                <form action="/search">
                    <input type="text" class="search-query" placeholder="Search Blog" name="query" title="全站搜索-只支持英文">
                </form>
            </div>
            <div id="toc"></div>
            <nav id="nav">
                <ul class="nav-list">
                    <li class="nav-link">
                    <a class="weibo "  href="http://weibo.com/1686537657/profile?topnav=1&wvr=6" ><i class="fa fa-weibo fa-2x"></i></a>
                    </li>
                    <li class="nav-link">
                    <a class="github" href="https://github.com/ivanpig"><i class="fa fa-github fa-2x"></i></a>
                    </li>
                    <li class="nav-link">
                    <a class="rss" href="/rss.xml" ><i class="fa fa-rss fa-2x"></i></a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="content pure-u-1 pure-u-md-3-4">
        <!--[if lt IE 8]>
        <i class="label label-danger">亲爱的用户，您的浏览器版本过低，建议您升级浏览器获得更好的用户体验</i>
        <![endif]-->
        <div>
            <div class="posts">

                <div class="qrcodeTable"></div>
<header class="post-header">
    <img class="post-avatar" height="48" width="48"
         src="">

    <h2 class="post-title">Clojure教程:Record和Protocol</h2>

    <p class="post-meta">By 05月11日  2014  



 
<a class="post-categorybut " href="/type/#"><i class="fa fa-folder-open"></i> clojure (11)</a>


  

  
</header>
<div class="article pure-u-22-24">
    <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 总结</a></li>
<li><a href="#sec-2">2. 个人感受</a></li>
</ul>
</div>
</div>
<p>
本文翻译自:<a href="http://www.jayway.com/2013/02/05/learn-clojure-using-records-and-protocols/">Learn Clojure using records and protocols</a></p>
<p>
当我对Clojure的括号不再疑惑后,另一个让我质疑为何要学习Clojure的问题是<br />
使用REPL很爽,但是我怎么来构建大型项目?".实际上,由于我的面向对象编程经<br />
验,我其实要问的是"我怎么才能将函数封装到类似class的东西里面去?".在本文<br />
中,我将会介绍一种类似于Java的方式来构建大型的Clojure项目.通过这种方式,<br />
希望你在学习Clojure的时候不会有太大的差异感!</p>
<p>
在Java中,我们出于各种目的而使用类.例如典型的使用Spring的web应用,你会看<br />
到类似下面的结构:</p>
<ul class="org-ul">
<li>Data transfer objects(DTO)
</li>
<li>Services(REST API,controllers,DAO)
</li>
<li>Rich object
</li>
</ul>
<p>
DTO实际上就是个结构体,他没有任何的行为(即方法).为了最小化样板代码,我趋<br />
向于使用pulibc final属性去实现DTO.我认为DTO就是个模板(schema),它就像<br />
一个REST服务输出的文件.但是我发现很多客户端开发人员可不关注这个,<br />
而只关注代码形式.有时你会看到DTO被作为数据库访问的一部分.这些DTO被称为<br />
贫血模型.<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup></p>
<p>
Service实际上是包含了方法和注入了辅助Service的单例对象.不同的辅助<br />
Service提供了不同的服务.除了实现了接口外,Service只是包含了方法,和占位符很类似.单例模式导致的一个问题就是,新手无法预见到多线程里共享相同的实例出现意外的结果.他们将状态保存到私有属性里,而不需要从一个对象传递到另一个对象.很方便,但是是错误的做法.</p>
<p>
Rich object是面向对象语言中的思想.即将数据及和数据相关的操作封装到一个<br />
类里面.我可没说getter和setter是相关操作!但是,rich object类在项目中用得<br />
较少.取而代之的是使用DTO作为Service的输入和输出.使用DAO来访问数据库,然<br />
后返回DTO.我没说这种方法是错误的,我好奇的是,既然对于目前的Java架构是好<br />
是坏我们都无法确认,那为什么还要强求使用Clojure去实现类似的东西呢?</p>
<p>
先不管这么多,我们先看怎么在Clojure中做类似的事情?我直接给出如何做!</p>
<p>
首先,DTO就是数据,而Clojure擅长数据处理,例如map,list和set.但是如果你想<br />
要类似结构体的东西,Clojure里提供了record.如果你了解Scala你会发现这玩样<br />
和case class很像.定义record的方式如下:</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #859900;">defrecord</span> <span style="color: #268bd2;">Person</span> [<span style="color: #cb4b16;">firstName</span> <span style="color: #cb4b16;">lastName</span>]<span style="color: #8c8c8c;">)</span>
</pre>
</div>
<p>
这实际上创建了一个叫Person的Java类,它包含两个不可变的属性以及实现了<br />
hashCode和equals方法.record的行为模式和map很像,所以大部分适用于map的方<br />
法都适用与record!需要注意的是,虽然Clojure是动态类型,但是你可以使用类型<br />
提示来标示特定类型:</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #859900;">defrecord</span> <span style="color: #268bd2;">Person</span> [<span style="color: #cb4b16;">^String</span> <span style="color: #cb4b16;">firstName</span> <span style="color: #cb4b16;">^String</span> <span style="color: #cb4b16;">lastName</span>]<span style="color: #8c8c8c;">)</span>
</pre>
</div>
<p>
好,那现在我们来看看如何定义Service!让我们将问题分解为组织相关函数,定义<br />
接口及依赖注入!</p>
<p>
和Java不同,Clojure提供了多种组织相关函数的方法.使用哪种方式完全取决于<br />
你想做什么.首先,在Clojure中,函数不需要定义到一个类里面.取而代之的是,他<br />
们通过命名空间类管理,命名空间类似于Java中的包.如果你没有任何特别的要求,那么建议使用命名空间来管理函数.</p>
<p>
如果你想定义类似class的东西,你需要先定义接口!那你需要使用protocol!你可<br />
以把它当做和Java中的接口类似的东西.实际上,除了使用protocol你也可以直接<br />
使用Java的接口,因为Clojure可以直接访问Java代码!创建protocol的方式如下:</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #859900;">defprotocol</span> <span style="color: #268bd2;">Greet</span>
    <span style="color: #8c8c8c;">(</span><span style="color: #cb4b16;">sayHello</span> [this]<span style="color: #8c8c8c;">)</span>
</pre>
</div>
<p>
这和下面的代码功能相同:</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #859900;">public</span> <span style="color: #859900;">interface</span> <span style="color: #b58900;">Greet</span>{
    <span style="color: #b58900;">Object</span> <span style="color: #268bd2;">sayHello</span>();
}
</pre>
</div>
<p>
有两点需要注意:</p>
<ul class="org-ul">
<li>你需要将this包含在参数列表中!在面向对象语言中默认都包含了this,在类内<br />
部调用时默认包含了this.而在外部调用方法时,是使用对象名称.方法名,比如<br />
person.sayHello().而Clojure是函数式的,方法在前,调用方式如下(sayHello<br />
person)
</li>
<li>方法返回的是Object.这是因为Clojure是函数式的,我们努力使其没有副作用.返<br />
回值为void的方法,实际上大部分是为了其副作用的!
</li>
</ul>
<p>
实现protocol可以使用如下代码:</p>
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #8c8c8c;">(</span><span style="color: #859900;">defrecord</span> <span style="color: #268bd2;">Person</span> [<span style="color: #cb4b16;">firstName</span> <span style="color: #cb4b16;">lastName</span>]
    <span style="color: #cb4b16;">Greet</span>
    <span style="color: #8c8c8c;">(</span><span style="color: #cb4b16;">sayHello</span> [this] <span style="color: #8c8c8c;">(</span><span style="color: #859900;">print</span> <span style="color: #2aa198;">"Hello,my name is "</span> <span style="color: #cb4b16;">firstName</span><span style="color: #8c8c8c;">)))</span>
</pre>
</div>
<p>
最后就是依赖注入了!结论是:依赖注入对与Clojure来说不是必要的!可以看看下<br />
面两篇文章!</p>
<ul class="org-ul">
<li><a href="http://tech.puredanger.com/2010/03/01/dependency-injection-clojure/">Dependency injection in Clojure</a>
</li>
<li><a href="http://stackoverflow.com/questions/13085370/what-is-the-clojure-equivalent-to-google-guice">What is the Clojure equivalent to Google Guice?</a>
</li>
</ul>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 总结</h2>
<div class="outline-text-2" id="text-1">
<p>
从Java过渡到Scala相对来说比较简单,因为你可以在Scala中编写类Java的代码,<br />
然后再慢慢过渡到函数式代码编写上.但是对于Clojure来说,没有这个过渡过程,<br />
所以比较难于适应!但是通过使用record和protocol可以使你能在Clojure中做类<br />
似Java的事情,从而简化你的过渡难度!</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 个人感受</h2>
<div class="outline-text-2" id="text-2">
<p>
不知道是英文不行,还是作者行文有问题!感觉作者的文字不够流畅!按照原文直<br />
译,总感觉不通顺!故做了删减调整!<br />
对于依赖注入提供的两篇文章,评论比文章好得多!特别是第二篇的第一个评论!<br />
其实本文就简单介绍了Clojure的record和protocol入门而已!</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup>
<p class="footpara">
译者注:猜测作者的意思是,有些开发人员不管类是DTO还是DAO,只要结构<br />
相同就随便用!</p>
</div>
</div>
</div>

</div>

    <div class="pure-g pagination">
        
        <a class="pure-u-1-2 pagination-item " href="/emacs-vim/%25e6%2589%258b%25e5%258a%25a8%25e5%25ae%2589%25e8%25a3%2585org-mode.html" title="手动安装Org-mode "><p> <i class="fa fa-mail-reply"></i>&nbsp;手动安装Org-mode</p></a>
        
        
        <a class="pure-u-1-2 pagination-item " href="/clojure/clojure%25e8%25bf%259b%25e9%2598%25b6%25e4%25bd%25bf%25e7%2594%25a8clojure%25e7%25bc%2596%25e5%2586%2599%25e6%2596%2587%25e5%25ad%2597%25e5%2586%2592%25e9%2599%25a9%25e6%25b8%25b8%25e6%2588%258f.html" title="Clojure进阶:使用Clojure编写文字冒险游戏"><p>Clojure进阶:使用Clojure编写文字冒险游戏&nbsp;<i class="fa fa-mail-forward"></i></p></a>
        
    </div>
    <link href="/css/code.css" rel="stylesheet">
    <link href="/css/min/fancybox.css" rel="stylesheet">
    <script src="/js/min/jquery.toc.min.js" ></script>
    <script src="/js/min/jquery.qrcode.min.js" ></script>
    <script src="/js/min/jquery.fancybox.pack.js" ></script>
    <script src="/js/page.js" ></script>

    
    

    
    
    <a name="comments"> </a>
<div id="comment">
    <div class="ds-thread" data-title="Clojure教程:Record和Protocol"></div>
    <script type="text/javascript">
        var duoshuoQuery = {short_name:""};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = '../js/min/duoshuo.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0]
                    || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
</div>

    






            </div>
            </div>
        <div class="footer">
                <a href="/love/welcome-my-blog.html">About</a>
                 <a href="/1">Collecting</a>
                <a href="tencent://message/?uin=561802774">QQ</a>
                <a href="https://github.com/ivanpig">GitHub</a>
            <script src="/js/min/nprogress.min.js"></script>
            <script src="/js/index.js"></script>
        </div>
        <div class="topfade"><a href="javascript:;" title="返回顶部"></a></div>

    </div>

</div>

</body>

</html>
